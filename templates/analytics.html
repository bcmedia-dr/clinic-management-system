<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ±è¨ˆåˆ†æ - Bcmedia è¨ºæ‰€ç®¡ç†ç³»çµ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            font-size: 32px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
        }

        .nav {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .nav-btn.active {
            background: white;
            color: #667eea;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 30px;
            color: #333;
        }

        /* çµ±è¨ˆå¡ç‰‡ */
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            text-align: center;
            transition: all 0.3s;
        }

        .stat-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-box .icon {
            font-size: 42px;
            margin-bottom: 12px;
        }

        .stat-box .label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .stat-box .value {
            font-size: 36px;
            font-weight: 700;
            color: #667eea;
        }

        /* åœ–è¡¨ç¶²æ ¼ */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
        }

        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }

        .chart-card:hover {
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            width: 100%;
            height: 400px;
        }

        .chart-container.tall {
            height: 500px;
        }

        @media (max-width: 1200px) {
            .stats-summary {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .stats-summary {
                grid-template-columns: 1fr;
            }
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="logo">ğŸ¥</div>
            <h1>Bcmedia è¨ºæ‰€ç®¡ç†ç³»çµ±</h1>
        </div>
        <div class="nav">
            <a href="/" class="nav-btn">ğŸ“‹ è¨ºæ‰€ç®¡ç†</a>
            <a href="/analytics" class="nav-btn active">ğŸ“Š çµ±è¨ˆåˆ†æ</a>
            <a href="/logout" class="nav-btn">ğŸšª ç™»å‡º</a>
        </div>
    </div>

    <div class="container">
        <h2 class="page-title">ğŸ“Š çµ±è¨ˆåˆ†æå„€è¡¨æ¿</h2>

        <!-- çµ±è¨ˆæ‘˜è¦å¡ç‰‡ -->
        <div class="stats-summary">
            <div class="stat-box">
                <div class="icon">ğŸ¥</div>
                <div class="label">ç¸½è¨ºæ‰€æ•¸</div>
                <div class="value" id="totalClinics">0</div>
            </div>
            <div class="stat-box">
                <div class="icon">ğŸ“</div>
                <div class="label">æ¶µè“‹ç¸£å¸‚</div>
                <div class="value" id="totalRegions">0</div>
            </div>
            <div class="stat-box">
                <div class="icon">ğŸ·ï¸</div>
                <div class="label">ç§‘åˆ¥ç¨®é¡</div>
                <div class="value" id="totalSpecialties">0</div>
            </div>
            <div class="stat-box">
                <div class="icon">âœ…</div>
                <div class="label">å¥åº·é†«è³¼</div>
                <div class="value" id="healthMallCount">0</div>
            </div>
        </div>

        <!-- åœ–è¡¨å€åŸŸ -->
        <div class="charts-grid">
            <!-- 1. å°ç£åœ°åœ– -->
            <div class="chart-card full-width">
                <h3 class="chart-title">ğŸ—ºï¸ å°ç£å„ç¸£å¸‚è¨ºæ‰€åˆ†å¸ƒåœ°åœ–</h3>
                <div id="taiwanMap" class="chart-container tall"></div>
            </div>

            <!-- 2. å„ç¸£å¸‚æ’è¡Œ -->
            <div class="chart-card">
                <h3 class="chart-title">ğŸ“Š å„ç¸£å¸‚è¨ºæ‰€æ•¸é‡æ’è¡Œ</h3>
                <div id="regionChart" class="chart-container"></div>
            </div>

            <!-- 3. ç§‘åˆ¥åˆ†å¸ƒ -->
            <div class="chart-card">
                <h3 class="chart-title">ğŸ·ï¸ è¨ºæ‰€ç§‘åˆ¥åˆ†å¸ƒ</h3>
                <div id="specialtyChart" class="chart-container"></div>
            </div>

            <!-- 4. å¥åº·é†«è³¼ç§‘åˆ¥åˆ†å¸ƒ -->
            <div class="chart-card">
                <h3 class="chart-title">âœ… å¥åº·é†«è³¼ç§‘åˆ¥åˆ†å¸ƒ</h3>
                <div id="healthMallSpecialtyChart" class="chart-container"></div>
            </div>

            <!-- 5. å¥åº·é†«è³¼åœ°å€åˆ†å¸ƒ -->
            <div class="chart-card">
                <h3 class="chart-title">ğŸ“ˆ å¥åº·é†«è³¼åœ°å€åˆ†å¸ƒ</h3>
                <div id="healthMallRegionChart" class="chart-container"></div>
            </div>
        </div>
    </div>

    <script>
        // è‰²å½©é…ç½®
        const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#fee140', '#30cfd0'];

        // è¼‰å…¥æ‰€æœ‰è³‡æ–™
        async function loadAllData() {
            try {
                const [statsRes, regionsRes, specialtiesRes, mapRes] = await Promise.all([
                    fetch('/api/stats'),
                    fetch('/api/analytics/regions'),
                    fetch('/api/analytics/specialties'),
                    fetch('/api/analytics/taiwan_map')
                ]);

                const stats = await statsRes.json();
                const regionsData = await regionsRes.json();
                const specialtiesData = await specialtiesRes.json();
                const mapData = await mapRes.json();

                // æ›´æ–°çµ±è¨ˆå¡ç‰‡
                document.getElementById('totalClinics').textContent = stats.total || 0;
                document.getElementById('totalRegions').textContent = regionsData.regions.length;
                document.getElementById('totalSpecialties').textContent = specialtiesData.specialties.length;
                
                // è¨ˆç®—å¥åº·é†«è³¼æ•¸é‡ï¼ˆåª’é«”é …ç›®åŒ…å«ã€Œå…¨éƒ¨ã€ï¼‰
                const clinicsRes = await fetch('/api/clinics');
                const clinics = await clinicsRes.json();
                const healthMallCount = clinics.filter(c => c.media_items && c.media_items.includes('å…¨éƒ¨')).length;
                document.getElementById('healthMallCount').textContent = healthMallCount;

                // ç¹ªè£½åœ–è¡¨
                drawTaiwanMap(mapData);
                drawRegionChart(regionsData);
                drawSpecialtyChart(specialtiesData);
                drawHealthMallSpecialtyChart(clinics);
                drawHealthMallRegionChart(clinics);

            } catch (error) {
                console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
            }
        }

        // 1. ç¹ªè£½å°ç£åœ°åœ–ï¼ˆå„ªåŒ–ç‰ˆï¼‰
        function drawTaiwanMap(data) {
            const chart = echarts.init(document.getElementById('taiwanMap'));
            
            const taiwanGeoJson = {
                "type": "FeatureCollection",
                "features": [
                    {"type":"Feature","properties":{"name":"å°åŒ—å¸‚"},"geometry":{"type":"Polygon","coordinates":[[[121.565,25.09],[121.51,25.04],[121.46,25.01],[121.45,24.98],[121.505,24.96],[121.59,24.99],[121.62,25.08],[121.61,25.13],[121.565,25.09]]]}},
                    {"type":"Feature","properties":{"name":"æ–°åŒ—å¸‚"},"geometry":{"type":"Polygon","coordinates":[[[121.8,25.2],[121.3,25.3],[121.2,25.0],[121.1,24.7],[121.4,24.6],[121.9,24.8],[122.0,25.1],[121.8,25.2]]]}},
                    {"type":"Feature","properties":{"name":"æ¡ƒåœ’å¸‚"},"geometry":{"type":"Polygon","coordinates":[[[121.45,25.1],[121.0,25.15],[120.85,24.85],[121.05,24.65],[121.35,24.7],[121.45,25.0],[121.45,25.1]]]}},
                    {"type":"Feature","properties":{"name":"å°ä¸­å¸‚"},"geometry":{"type":"Polygon","coordinates":[[[121.2,24.5],[120.5,24.6],[120.4,24.0],[120.6,23.8],[121.0,23.9],[121.2,24.3],[121.2,24.5]]]}},
                    {"type":"Feature","properties":{"name":"å°å—å¸‚"},"geometry":{"type":"Polygon","coordinates":[[[120.5,23.3],[120.0,23.4],[119.9,22.9],[120.1,22.7],[120.4,22.8],[120.5,23.1],[120.5,23.3]]]}},
                    {"type":"Feature","properties":{"name":"é«˜é›„å¸‚"},"geometry":{"type":"Polygon","coordinates":[[[120.7,23.0],[120.2,23.1],[120.0,22.5],[120.2,22.3],[120.5,22.4],[120.7,22.8],[120.7,23.0]]]}},
                    {"type":"Feature","properties":{"name":"æ–°ç«¹å¸‚"},"geometry":{"type":"Polygon","coordinates":[[[121.0,24.85],[120.9,24.75],[120.95,24.7],[121.05,24.75],[121.0,24.85]]]}},
                    {"type":"Feature","properties":{"name":"åŸºéš†å¸‚"},"geometry":{"type":"Polygon","coordinates":[[[121.75,25.15],[121.65,25.1],[121.7,25.05],[121.8,25.1],[121.75,25.15]]]}},
                    {"type":"Feature","properties":{"name":"å˜‰ç¾©å¸‚"},"geometry":{"type":"Polygon","coordinates":[[[120.48,23.5],[120.42,23.45],[120.46,23.42],[120.52,23.46],[120.48,23.5]]]}}
                ]
            };
            
            echarts.registerMap('taiwan', taiwanGeoJson);
            
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}<br/>è¨ºæ‰€æ•¸é‡: {c} é–“',
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    borderColor: '#667eea',
                    borderWidth: 1,
                    textStyle: {
                        color: '#333',
                        fontSize: 14
                    }
                },
                visualMap: {
                    min: 0,
                    max: Math.max(...data.map(d => d.value), 10),
                    text: ['å¤š', 'å°‘'],
                    realtime: false,
                    calculable: true,
                    inRange: {
                        color: ['#e0f3ff', '#90caf9', '#42a5f5', '#1e88e5', '#1565c0']
                    },
                    textStyle: {
                        color: '#333'
                    }
                },
                series: [{
                    name: 'è¨ºæ‰€æ•¸é‡',
                    type: 'map',
                    map: 'taiwan',
                    roam: true,
                    label: {
                        show: true,
                        fontSize: 11,
                        color: '#333',
                        fontWeight: 'bold'
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: 13,
                            color: '#fff'
                        },
                        itemStyle: {
                            areaColor: '#667eea',
                            shadowBlur: 10,
                            shadowColor: 'rgba(0, 0, 0, 0.3)'
                        }
                    },
                    data: data
                }]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        // 2. ç¹ªè£½ç¸£å¸‚æ’è¡Œï¼ˆå„ªåŒ–ç‰ˆï¼‰
        function drawRegionChart(data) {
            const chart = echarts.init(document.getElementById('regionChart'));
            
            const sortedData = data.regions.map((region, index) => ({
                region: region,
                count: data.counts[index]
            })).sort((a, b) => b.count - a.count);
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: '{b}<br/>è¨ºæ‰€æ•¸é‡: {c} é–“'
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: sortedData.map(d => d.region),
                    axisLabel: {
                        rotate: 45,
                        fontSize: 12
                    },
                    axisLine: {
                        lineStyle: { color: '#ddd' }
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLine: {
                        lineStyle: { color: '#ddd' }
                    },
                    splitLine: {
                        lineStyle: { color: '#f0f0f0' }
                    }
                },
                series: [{
                    name: 'è¨ºæ‰€æ•¸é‡',
                    type: 'bar',
                    data: sortedData.map(d => d.count),
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#667eea' },
                            { offset: 1, color: '#764ba2' }
                        ]),
                        borderRadius: [8, 8, 0, 0]
                    },
                    label: {
                        show: true,
                        position: 'top',
                        fontSize: 12,
                        fontWeight: 'bold'
                    },
                    emphasis: {
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#5568d3' },
                                { offset: 1, color: '#6a3d8f' }
                            ])
                        }
                    }
                }]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        // 3. ç¹ªè£½ç§‘åˆ¥åˆ†å¸ƒï¼ˆå„ªåŒ–ç‰ˆï¼‰
        function drawSpecialtyChart(data) {
            const chart = echarts.init(document.getElementById('specialtyChart'));
            
            const chartData = data.specialties.map((specialty, index) => ({
                name: specialty,
                value: data.counts[index]
            })).sort((a, b) => b.value - a.value);
            
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}<br/>æ•¸é‡: {c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    textStyle: { fontSize: 12 }
                },
                series: [{
                    name: 'ç§‘åˆ¥',
                    type: 'pie',
                    radius: ['45%', '70%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 10,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        formatter: '{b}\n{d}%',
                        fontSize: 11
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: 14,
                            fontWeight: 'bold'
                        },
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.3)'
                        }
                    },
                    data: chartData.map((item, index) => ({
                        ...item,
                        itemStyle: {
                            color: colors[index % colors.length]
                        }
                    }))
                }]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        // 4. ç¹ªè£½å¥åº·é†«è³¼ç§‘åˆ¥åˆ†å¸ƒï¼ˆæ–°å¢ï¼‰
        function drawHealthMallSpecialtyChart(clinics) {
            const chart = echarts.init(document.getElementById('healthMallSpecialtyChart'));
            
            // ç¯©é¸å‡ºå¥åº·é†«è³¼è¨ºæ‰€ï¼ˆåª’é«”é …ç›®åŒ…å«ã€Œå…¨éƒ¨ã€ï¼‰
            const healthMallClinics = clinics.filter(c => c.media_items && c.media_items.includes('å…¨éƒ¨'));
            
            // çµ±è¨ˆå„ç§‘åˆ¥æ•¸é‡
            const specialtyCount = {};
            healthMallClinics.forEach(clinic => {
                if (clinic.specialties) {
                    const specs = clinic.specialties.split(',').map(s => s.trim());
                    specs.forEach(spec => {
                        specialtyCount[spec] = (specialtyCount[spec] || 0) + 1;
                    });
                }
            });
            
            const chartData = Object.entries(specialtyCount)
                .map(([name, value]) => ({ name, value }))
                .sort((a, b) => b.value - a.value);
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: '{b}<br/>æ•¸é‡: {c} é–“'
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: chartData.map(d => d.name),
                    axisLabel: {
                        rotate: 45,
                        fontSize: 12
                    }
                },
                yAxis: {
                    type: 'value'
                },
                series: [{
                    name: 'æ•¸é‡',
                    type: 'bar',
                    data: chartData.map(d => d.value),
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#4ade80' },
                            { offset: 1, color: '#22c55e' }
                        ]),
                        borderRadius: [8, 8, 0, 0]
                    },
                    label: {
                        show: true,
                        position: 'top',
                        fontSize: 12,
                        fontWeight: 'bold'
                    }
                }]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        // 5. ç¹ªè£½å¥åº·é†«è³¼åœ°å€åˆ†å¸ƒï¼ˆæ–°å¢ï¼‰
        function drawHealthMallRegionChart(clinics) {
            const chart = echarts.init(document.getElementById('healthMallRegionChart'));
            
            // çµ±è¨ˆå„åœ°å€çš„å¥åº·é†«è³¼å’Œéå¥åº·é†«è³¼æ•¸é‡
            const regionData = {};
            clinics.forEach(clinic => {
                if (clinic.region) {
                    if (!regionData[clinic.region]) {
                        regionData[clinic.region] = { yes: 0, no: 0 };
                    }
                    if (clinic.media_items && clinic.media_items.includes('å…¨éƒ¨')) {
                        regionData[clinic.region].yes++;
                    } else {
                        regionData[clinic.region].no++;
                    }
                }
            });
            
            const regions = Object.keys(regionData).sort();
            const yesData = regions.map(r => regionData[r].yes);
            const noData = regions.map(r => regionData[r].no);
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: function(params) {
                        let result = params[0].axisValue + '<br/>';
                        params.forEach(item => {
                            result += item.marker + item.seriesName + ': ' + item.value + ' é–“<br/>';
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['å¥åº·é†«è³¼', 'éå¥åº·é†«è³¼']
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: regions,
                    axisLabel: {
                        rotate: 45,
                        fontSize: 12
                    }
                },
                yAxis: {
                    type: 'value'
                },
                series: [
                    {
                        name: 'å¥åº·é†«è³¼',
                        type: 'bar',
                        stack: 'total',
                        data: yesData,
                        itemStyle: { color: '#4ade80' },
                        label: {
                            show: true,
                            position: 'inside',
                            formatter: '{c}'
                        }
                    },
                    {
                        name: 'éå¥åº·é†«è³¼',
                        type: 'bar',
                        stack: 'total',
                        data: noData,
                        itemStyle: { color: '#f87171' },
                        label: {
                            show: true,
                            position: 'inside',
                            formatter: '{c}'
                        }
                    }
                ]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', loadAllData);
    </script>
</body>
</html>
